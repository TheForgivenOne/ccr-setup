#!/bin/bash

# Claude Code Qwen Deployment Script for Linux
# Automates the setup of Claude Code with Qwen models for free usage

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Function to check prerequisites
check_prerequisites() {
    log_info "Checking prerequisites..."

    # Check if Node.js is installed and version >= 18
    if ! command -v node &> /dev/null; then
        log_error "Node.js is not installed. Please install Node.js v18+ first."
        exit 1
    fi

    NODE_VERSION=$(node --version | sed 's/v//')
    NODE_MAJOR=$(echo $NODE_VERSION | cut -d. -f1)

    if [ "$NODE_MAJOR" -lt 18 ]; then
        log_error "Node.js version is $NODE_VERSION. Please upgrade to Node.js v18+."
        exit 1
    fi

    log_info "Node.js version: $NODE_VERSION âœ“"
}

# Function to install required npm packages
install_packages() {
    log_info "Installing required npm packages..."

    npm install -g @qwen-code/qwen-code@latest
    log_success "@qwen-code/qwen-code installed"

    npm install -g @anthropic-ai/claude-code @musistudio/claude-code-router
    log_success "Claude Code and Router installed"
}


# Function to initialize router with default config first
initialize_router() {
    log_info "Initializing Claude Code Router..."

    # Start the router in the background to create default config
    ccr start

    # Wait a moment for the router to initialize
    sleep 3

    log_success "Router initialized with default configuration"
}

# Function to create router configuration
create_router_config() {
    log_info "Creating custom router configuration..."

    CONFIG_DIR="$HOME/.claude-code-router"
    CONFIG_FILE="$CONFIG_DIR/config.json"

    # Create config directory if it doesn't exist
    mkdir -p "$CONFIG_DIR"

    # Create the configuration file
    cat > "$CONFIG_FILE" << 'EOF'
{
  "LOG": true,
  "LOG_LEVEL": "info",
  "HOST": "127.0.0.1",
  "PORT": 3456,
  "API_TIMEOUT_MS": 600000,
  "Providers": [
    {
      "name": "qwen",
      "api_base_url": "https://portal.qwen.ai/v1/chat/completions",
      "api_key": "$QWEN_ACCESS_TOKEN",
      "models": [
        "qwen3-coder-plus",
        "qwen3-coder-plus",
        "qwen3-coder-plus"
      ]
    }
  ],
  "Router": {
    "default": "qwen,qwen3-coder-plus",
    "background": "qwen,qwen3-coder-plus",
    "think": "qwen,qwen3-coder-plus",
    "longContext": "qwen,qwen3-coder-plus",
    "longContextThreshold": 60000,
    "webSearch": "qwen,qwen3-coder-plus"
  }
}
EOF

    log_success "Router configuration created at $CONFIG_FILE"
    log_warn "Note: You need to set the QWEN_ACCESS_TOKEN environment variable with your actual token"
}


# Function to verify setup
verify_setup() {
    log_info "Verifying setup..."

    # Check if tools are available
    if command -v claude &> /dev/null; then
        CLAUDE_VERSION=$(claude --version 2>&1 || true)
        log_success "Claude Code version: $CLAUDE_VERSION"
    else
        log_error "Claude Code not found"
        return 1
    fi

    if command -v ccr &> /dev/null; then
        CCR_VERSION=$(ccr version 2>&1 || true)
        log_success "Claude Code Router version: $CCR_VERSION"
    else
        log_error "Claude Code Router not found"
        return 1
    fi

    # Skip checking for QWEN_ACCESS_TOKEN since user needs to set it manually
    log_warn "QWEN_ACCESS_TOKEN needs to be set manually in your shell configuration"
    log_info "Remember to add 'export QWEN_ACCESS_TOKEN=\"YOUR_TOKEN\"' to ~/.zshrc and ~/.bashrc"

    # Check if config file exists
    if [ -f "$HOME/.claude-code-router/config.json" ]; then
        log_success "Router configuration file exists"
    else
        log_error "Router configuration file does not exist"
        return 1
    fi

    return 0
}

# Function to start the router
start_router() {
    log_info "Starting Claude Code Router..."

    # Restart the router server
    ccr restart

    log_success "Claude Code Router started"
}

# Function to display usage instructions
display_usage() {
    log_info "Setup completed successfully!"
    echo
    log_success "You can now use Claude Code with Qwen models:"
    echo "  - YOU MUST set the QWEN_ACCESS_TOKEN environment variable first!"
    echo "  - Add 'export QWEN_ACCESS_TOKEN=\"YOUR_TOKEN\"' to ~/.zshrc and ~/.bashrc"
    echo "  - Run 'source ~/.zshrc' and 'source ~/.bashrc' or open a new terminal"
    echo "  - Then run 'ccr code' to start Claude Code"
    echo "  - Type '> hi' to test the connection"
    echo
    log_warn "IMPORTANT: Without setting QWEN_ACCESS_TOKEN, Claude Code will not work with Qwen models!"
    echo
    log_info "For token refresh (when getting 401 errors):"
    echo "  1. Re-authenticate with Qwen CLI: 'qwen login'"
    echo "  2. Update your config: 'nano ~/.claude-code-router/config.json'"
    echo "  3. Restart router: 'ccr restart'"
    echo
    log_success "Enjoy Claude Code with Qwen models for free! ðŸ’–"
}

# Main execution function
main() {
    log_info "Starting Claude Code Qwen Deployment Script"

    # Check prerequisites
    check_prerequisites

    # Install required packages
    install_packages

    # Initialize router in background to create default config
    initialize_router

    # Create custom router configuration
    create_router_config

    log_info "IMPORTANT: You need to manually add the environment variable to your shell configuration:"
    log_info "  1. Add 'export QWEN_ACCESS_TOKEN=\"YOUR_ACTUAL_TOKEN_HERE\"' to your ~/.zshrc and ~/.bashrc"
    log_info "  2. Run 'source ~/.zshrc' and 'source ~/.bashrc' or open a new terminal"

    # Restart the router to apply new configuration
    log_info "Restarting Claude Code Router with new configuration..."
    ccr restart

    # Wait a moment for the router to restart
    sleep 3

    # Verify the setup
    if verify_setup; then
        log_success "All verifications passed âœ“"

        # Display usage instructions
        display_usage
    else
        log_error "Verification failed. Please check the errors above."
        exit 1
    fi
}

# Run main function
main "$@"%         
